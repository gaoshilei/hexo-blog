<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="LeonLei" />



<meta name="description" content="前言此文为逆向微信二进制文件，实现朋友圈小视频转发的教程，从最开始的汇编代码入手到最后重签名安装等操作，手把手教你玩转微信！学会之后再去逆向微信其他功能易如反掌。本篇文章由于篇幅太长分成了两篇，上篇讲解的是逆向工作，也就是怎么找到相关的函数和方法实现，下篇讲解的是怎么在非越狱机重签名安装和越狱机tweak安装的详细过程。正文的第二部分还提供了微信自动抢红包、修改微信步数的代码，这些都可以照葫芦画瓢">
<meta property="og:type" content="article">
<meta property="og:title" content="手把手教你逆向微信之朋友圈小视频转发（上）">
<meta property="og:url" content="http://www.gaoshilei.com/2016/11/09/手把手教你逆向微信之朋友圈小视频转发（上）/index.html">
<meta property="og:site_name" content="LeonLei的博客">
<meta property="og:description" content="前言此文为逆向微信二进制文件，实现朋友圈小视频转发的教程，从最开始的汇编代码入手到最后重签名安装等操作，手把手教你玩转微信！学会之后再去逆向微信其他功能易如反掌。本篇文章由于篇幅太长分成了两篇，上篇讲解的是逆向工作，也就是怎么找到相关的函数和方法实现，下篇讲解的是怎么在非越狱机重签名安装和越狱机tweak安装的详细过程。正文的第二部分还提供了微信自动抢红包、修改微信步数的代码，这些都可以照葫芦画瓢">
<meta property="og:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91Reveal.png">
<meta property="og:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91-%E8%BD%AC%E5%8F%91%E5%B0%8F%E8%A7%86%E9%A2%91%E4%B8%BA%E7%A9%BA.jpg">
<meta property="og:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91-selRef_section%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85.png">
<meta property="og:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91-btnRelease.png">
<meta property="og:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91sub_10261D0AC.png">
<meta property="og:updated_time" content="2016-11-20T08:15:04.317Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="手把手教你逆向微信之朋友圈小视频转发（上）">
<meta name="twitter:description" content="前言此文为逆向微信二进制文件，实现朋友圈小视频转发的教程，从最开始的汇编代码入手到最后重签名安装等操作，手把手教你玩转微信！学会之后再去逆向微信其他功能易如反掌。本篇文章由于篇幅太长分成了两篇，上篇讲解的是逆向工作，也就是怎么找到相关的函数和方法实现，下篇讲解的是怎么在非越狱机重签名安装和越狱机tweak安装的详细过程。正文的第二部分还提供了微信自动抢红包、修改微信步数的代码，这些都可以照葫芦画瓢">
<meta name="twitter:image" content="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91Reveal.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="LeonLei的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="http://oeat6c2zg.bkt.clouddn.com/12829050723725-1.jpg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>手把手教你逆向微信之朋友圈小视频转发（上） | LeonLei的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?fa5932171fa37a04ffd60b500f75d9fa";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://oeat6c2zg.bkt.clouddn.com/12829050723725-1.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">LeonLei</a></h1>
        </hgroup>

        
        <p class="header-subtitle">代码略懂，精通LOL</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:goslei1315@gmail.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/goslei1226" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/gaoshilei" title="GitHub"></a>
                            
                                <a class="fa Facebook" href="https://www.facebook.com/profile.php?id=100002888296778" title="Facebook"></a>
                            
                                <a class="fa Twitter" href="https://twitter.com/LeonLei_Gao" title="Twitter"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cocopods/">Cocopods</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDK/">SDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shadowsockts/">Shadowsockts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UDID/">UDID</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPN/">VPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS/">VPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xcode/">Xcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/">framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serial-Number/">serial Number</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态库/">动态库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信/">微信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/逆向工程/">逆向工程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/重签名/">重签名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态库/">静态库</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" href="/">friends</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">一个脱离了低级趣味的伪全栈iOS攻城狮</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">LeonLei</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://oeat6c2zg.bkt.clouddn.com/12829050723725-1.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">LeonLei</a></h1>
            </hgroup>
            
            <p class="header-subtitle">代码略懂，精通LOL</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:goslei1315@gmail.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/goslei1226" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/gaoshilei" title="GitHub"></a>
                            
                                <a class="fa Facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100002888296778" title="Facebook"></a>
                            
                                <a class="fa Twitter" target="_blank" href="https://twitter.com/LeonLei_Gao" title="Twitter"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-手把手教你逆向微信之朋友圈小视频转发（上）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/09/手把手教你逆向微信之朋友圈小视频转发（上）/" class="article-date">
      <time datetime="2016-11-09T16:00:00.000Z" itemprop="datePublished">2016-11-10</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      手把手教你逆向微信之朋友圈小视频转发（上）
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/逆向工程/">逆向工程</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信/">微信</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/逆向工程/">逆向工程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/重签名/">重签名</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>此文为逆向微信二进制文件，实现朋友圈小视频转发的教程，从最开始的汇编代码入手到最后重签名安装等操作，手把手教你玩转微信！学会之后再去逆向微信其他功能易如反掌。<br>本篇文章由于篇幅太长分成了两篇，<strong>上篇</strong>讲解的是逆向工作，也就是怎么找到相关的函数和方法实现，<strong>下篇</strong>讲解的是怎么在非越狱机重签名安装和越狱机tweak安装的详细过程。<br><strong>正文的第二部分还提供了微信自动抢红包、修改微信步数的代码，这些都可以照葫芦画瓢按照本文的套路一步步逆向找到，这里就不再赘述。</strong><br>在实践之前，需要准备好一部越狱的手机，然后将下文列出的所有工具安装好。IDA跟Reveal都是破解版，IDA的正版要2000多刀，对于这么牛逼的逆向工具确实物有所值，不过不是专门研究逆向的公司也没必要用正版的，下个Windows的破解版就好，Mac上暂时没找到。Mac上可以用hopper代替IDA，也是一款很牛逼的逆向工具。废话不多说，正式开始吧！</p>
<a id="more"></a>
<p>转载请注明出处：<a href="http://www.gaoshilei.com">来自LeonLei的博客http://www.gaoshilei.com</a>  </p>
<h1 id="逆向微信朋友圈（上篇）"><a href="#逆向微信朋友圈（上篇）" class="headerlink" title="逆向微信朋友圈（上篇）"></a>逆向微信朋友圈（上篇）</h1><h2 id="一、获取朋友圈的小视频"><a href="#一、获取朋友圈的小视频" class="headerlink" title="一、获取朋友圈的小视频"></a>一、获取朋友圈的小视频</h2><blockquote>
<p>   注意：本文逆向的微信的二进制文件为6.3.28版本，如果是不同的微信版本，二进制文件中的基地址也不相同</p>
</blockquote>
<h4 id="本文涉及到的工具"><a href="#本文涉及到的工具" class="headerlink" title="本文涉及到的工具"></a>本文涉及到的工具</h4><ol>
<li><a href="http://www.cycript.org" target="_blank" rel="external">cycript</a> </li>
<li>LLDB与debugserver（Xcode自带）</li>
<li>OpenSSH</li>
<li>IDA</li>
<li>Reveal</li>
<li><a href="https://github.com/theos/theos" target="_blank" rel="external">theos</a></li>
<li><a href="http://www.cydiasubstrate.com" target="_blank" rel="external">CydiaSubstrate</a></li>
<li>iOSOpenDev</li>
<li>ideviceinstaller</li>
<li>tcprelay（本地端口映射，USB连接SSH，不映射可通过WiFi连接） </li>
<li><a href="https://github.com/stefanesser/dumpdecrypted" target="_blank" rel="external">dumpdecrypted</a></li>
<li><a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="external">class-dump</a> </li>
<li><a href="https://github.com/DanTheMan827/ios-app-signer" target="_blank" rel="external">iOS App Signer</a></li>
<li>编译好的<a href="https://github.com/gaoshilei/yololib" target="_blank" rel="external">yololib</a></li>
</ol>
<p><strong>逆向环境为MacOS    +    iPhone5S 9.1越狱机</strong><br>先用dumpdecrypted给微信砸壳（不会的请我写的看<a href="http://www.gaoshilei.com/2016/08/08/dumpdecrypted给App砸壳/">这篇教程</a>），获得一个WeChat.decrypted文件，先把这个文件扔到IDA中分析（60MB左右的二进制文件，IDA差不多40分钟才能分析完），用class-dump导出所有头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LeonLei-MBP:~ gaoshilei$ class-dump -S -s -H /Users/gaoshilei/Desktop/reverse/binary_for_class-dump/WeChat.decrypted -o /Users/gaoshilei/Desktop/reverse/binary_for_class-dump/class-Header/WeChat</div></pre></td></tr></table></figure>
<p>我滴个亲娘！一共有8000个头文件，微信果然工程量浩大！稳定一下情绪，理一理思路继续搞。要取得小视频的下载链接，找到播放视频的View，顺藤摸瓜就能找到小视频的URL。用Reveal查看小视频的播放窗口<br><img src="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91Reveal.png" alt="Reveal"><br>可以看出来WCContentItemViewTemplateNewSigh这个对象是小视频的播放窗口，它的subView有WCSightView，SightView、SightPlayerView，这几个类就是我们的切入点。<br>保存视频到favorite的时候是长按视频弹出选项的，那么在WCContentItemViewTemplateNewSight这个类里面可能有手势相关的方法，去刚才导出的头文件中找线索。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)onLongTouch;</div><div class="line">- (void)onLongPressedWCSight:(id)arg1;</div><div class="line">- (void)onLongPressedWCSightFullScreenWindow:(id)arg1;</div></pre></td></tr></table></figure>
<p>这几个方法跟长按手势相关，再去IDA中找到这些函数，逐个查看。onLongPressedWCSight和onLongPressedWCSightFullScreenWindow都比较简单，onLongTouch比较长，而且发现了内部调用了方法Favorites_Add，因为长按视频的时候出来一个选项就是Favorites，并且我看到这个函数调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ADRP            X8, #selRef_sightVideoPath@PAGE</div><div class="line">LDR             X1, [X8,#selRef_sightVideoPath@PAGEOFF]</div></pre></td></tr></table></figure>
<p>这里拿到了小视频的地址，可以推测这个函数跟收藏有关，下面打断点测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) im li -o -f</div><div class="line">[  0] 0x000000000003c000 /var/mobile/Containers/Bundle/Application/2F1D52EC-C57E-4F95-B715-EF04351232E8/WeChat.app/WeChat(0x000000010003c000)</div></pre></td></tr></table></figure>
<p>可以看到WeChat的ASLR为0x3c000，在IDA查找到这三个函数的基地址，分别下断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(lldb) br s -a 0x1020D3A10+0x3c000</div><div class="line">Breakpoint 1: where = WeChat`___lldb_unnamed_symbol110094$$WeChat + 28, address = 0x000000010210fa10</div><div class="line">(lldb) br s -a 0x1020D3370+0x3c000</div><div class="line">Breakpoint 2: where = WeChat`___lldb_unnamed_symbol110091$$WeChat + 8, address = 0x000000010210f370</div><div class="line">(lldb) br s -a 0x1020D33E4+0x3c000</div><div class="line">Breakpoint 3: where = WeChat`___lldb_unnamed_symbol110092$$WeChat + 12, address = 0x000000010210f3e4</div></pre></td></tr></table></figure>
<p>回到微信里面长按小视频，看断点触发情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Process 3721 stopped</div><div class="line">* thread #1: tid = 0x658fc, 0x000000010210f370 WeChat`___lldb_unnamed_symbol110091$$WeChat + 8, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 2.1</div><div class="line">    frame #0: 0x000000010210f370 WeChat`___lldb_unnamed_symbol110091$$WeChat + 8</div><div class="line">WeChat`___lldb_unnamed_symbol110091$$WeChat:</div><div class="line">-&gt;  0x10210f370 &lt;+8&gt;:  add    x29, sp, #16              ; =16 </div><div class="line">    0x10210f374 &lt;+12&gt;: mov    x19, x0</div><div class="line">    0x10210f378 &lt;+16&gt;: adrp   x8, 4968</div><div class="line">    0x10210f37c &lt;+20&gt;: ldr    x0, [x8, #744]</div><div class="line">(lldb) c</div><div class="line">Process 3721 resuming</div><div class="line">Process 3721 stopped</div><div class="line">* thread #1: tid = 0x658fc, 0x000000010210fa10 WeChat`___lldb_unnamed_symbol110094$$WeChat + 28, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 1.1</div><div class="line">    frame #0: 0x000000010210fa10 WeChat`___lldb_unnamed_symbol110094$$WeChat + 28</div><div class="line">WeChat`___lldb_unnamed_symbol110094$$WeChat:</div><div class="line">-&gt;  0x10210fa10 &lt;+28&gt;: add    x29, sp, #96              ; =96 </div><div class="line">    0x10210fa14 &lt;+32&gt;: sub    sp, sp, #96               ; =96 </div><div class="line">    0x10210fa18 &lt;+36&gt;: mov    x19, x0</div><div class="line">    0x10210fa1c &lt;+40&gt;: adrp   x8, 4863</div><div class="line">……</div></pre></td></tr></table></figure>
<p>发现断点2先被触发，接着触发断点1，后面断点2和1又各触发了1次，断点3一直很安静。可以排除onLongPressedWCSightFullScreenWindow与收藏小视频的联系。小视频的踪影就要在剩下的两个方法中寻找了。通过V找到C，顺藤摸瓜找到M屡试不爽！用cycript注入WeChat，拿到播放小视频的view所在的Controller。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cy# [#0x138c18030 nextResponder]</div><div class="line">#&quot;&lt;WCTimeLineCellView: 0x138c34620; frame = (0 0; 319 249); tag = 1048577; layer = &lt;CALayer: 0x138362ba0&gt;&gt;&quot;</div><div class="line">cy# [#0x138c34620 nextResponder]</div><div class="line">#&quot;&lt;UITableViewCellContentView: 0x138223c70; frame = (0 0; 320 256); gestureRecognizers = &lt;NSArray: 0x1384ec480&gt;; layer = &lt;CALayer: 0x138081dc0&gt;&gt;&quot;</div><div class="line">cy# [#0x138223c70 nextResponder]</div><div class="line">#&quot;&lt;MMTableViewCell: 0x138c9f930; baseClass = UITableViewCell; frame = (0 307; 320 256); autoresize = W; layer = &lt;CALayer: 0x1382dcd10&gt;&gt;&quot;</div><div class="line">cy# [#0x138c9f930 nextResponder]</div><div class="line">#&quot;&lt;UITableViewWrapperView: 0x137b57800; frame = (0 0; 320 504); gestureRecognizers = &lt;NSArray: 0x1383db660&gt;; layer = &lt;CALayer: 0x138af20c0&gt;; contentOffset: &#123;0, 0&#125;; contentSize: &#123;320, 504&#125;&gt;&quot;</div><div class="line">cy# [#0x137b57800 nextResponder]</div><div class="line">#&quot;&lt;MMTableView: 0x137b8ae00; baseClass = UITableView; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x138adb590&gt;; layer = &lt;CALayer: 0x138956890&gt;; contentOffset: &#123;0, 99.5&#125;; contentSize: &#123;320, 3193&#125;&gt;&quot;</div><div class="line">cy# [#0x137b8ae00 nextResponder]</div><div class="line">#&quot;&lt;UIView: 0x138ade5c0; frame = (0 0; 320 568); autoresize = W+H; layer = &lt;CALayer: 0x138ac9990&gt;&gt;&quot;</div><div class="line">cy# [#0x138ade5c0 nextResponder]</div><div class="line">#&quot;&lt;WCTimeLineViewController: 0x1379eb000&gt;&quot;</div></pre></td></tr></table></figure>
<p>通过响应者链条找到<br>WCContentItemViewTemplateNewSight所属的Controller为WCTimeLineViewController。在这个类的头文件中并没有发现有价值的线索，不过我们注意到小视频所在的view是属于MMTableVIewCell的（见上图Reveal分析图），这是每一个iOS最熟悉的TableView，cell的数据是通过UITableViewDataSource的代理方法<code>- tableView:cellForRowAtIndexPath:</code>赋值的，通过这个方法肯定能知道到M的影子。在IDA中找到<code>[WCTimeLineViewController tableView:cellForRowAtIndexPath:]</code>,定位到基地址0x10128B6B0位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__text:000000010128B6B0     ADRP     X8, #selRef_genNormalCell_indexPath_@PAGE</div></pre></td></tr></table></figure>
<p>这里的函数是WCTimeLineViewController中生成cell的方法，除了这个方法在这个类中还有另外三个生成cell的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)genABTestTipCell:(id)arg1 indexPath:(id)arg2;</div><div class="line">- (void)genRedHeartCell:(id)arg1 indexPath:(id)arg2;</div><div class="line">- (void)genUploadFailCell:(id)arg1 indexPath:(id)arg2;</div></pre></td></tr></table></figure>
<p>通过字面意思可以猜测出normal这个应该是生成小视频cell的方法。继续在IDA中寻找线索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__text:0000000101287CC8     ADRP     X8, #selRef_getTimelineDataItemOfIndex_@PAGE</div></pre></td></tr></table></figure>
<p>在<code>genNormalCell:IndexPath:</code>方法中发现上面这个方法，可以大胆猜想这个方法是获取TimeLine（朋友圈）数据的方法，那小视频的数据肯定也是通过这个方法获取的，并且IDA可以看到这个方法中调用一个叫做<code>selRef_getTimelineDataItemOfIndex_</code>的方法，获取DataItem貌似就是cell的数据源啊！接下来用LLDB下断点验证猜想。<br>通过IDA可以找到这个方法对应的基地址为：0x101287CE4，先打印正在运行WeChat的ASLR偏移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LeonLei-MBP:~ gaoshilei$ lldb</div><div class="line">(lldb) process connect connect://localhost:1234</div><div class="line">(lldb) im li -o -f </div><div class="line">[0] 0x0000000000050000 /var/mobile/Containers/Bundle/Application/2DCE8F30-9B6B-4652-901C-37EB1FF2A40D/WeChat.app/WeChat(0x0000000100050000)</div></pre></td></tr></table></figure>
<p>所以我们下断点的位置是0x50000+0x101287CE4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) br s -a 0x50000+0x101287CE4</div><div class="line">Breakpoint 1: where = WeChat`___lldb_unnamed_symbol63721$$WeChat + 252, address = 0x00000001012d7ce4</div></pre></td></tr></table></figure>
<p>打印x0的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(lldb) po $x0</div><div class="line">Class name: WCDataItem, addr: 0x15f5f03b0</div><div class="line">tid: 12393001887435993280</div><div class="line">username: wxid_z8twcz4o18fg12</div><div class="line">createtime: 1477360950</div><div class="line">commentUsers: (</div><div class="line">)</div><div class="line">contentObj: &lt;WCContentItem: 0x15f57d000&gt;</div></pre></td></tr></table></figure>
<p>得到一个WCDataItem的对象，这里x0的值就是<code>selRef_getTimelineDataItemOfIndex_</code>执行完的返回值，然后把x0的值改掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) register write $x0 0</div><div class="line">(lldb) c</div></pre></td></tr></table></figure>
<p>此时会发现我们要刷新的那条小视频内容全部为空<br><img src="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91-%E8%BD%AC%E5%8F%91%E5%B0%8F%E8%A7%86%E9%A2%91%E4%B8%BA%E7%A9%BA.jpg" alt="小视频内容为空"><br>到这里已经找到了小视频的源数据获取方法，问题是我们怎么拿到这个WCDataItem呢？继续看IDA分析函数的调用情况：  </p>
<blockquote>
<p>   WCTimeLineViewController - (void)genNormalCell:(id) indexPath:(id)  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">__text:0000000101287BCC                 STP             X28, X27, [SP,#var_60]!</div><div class="line">__text:0000000101287BD0                 STP             X26, X25, [SP,#0x60+var_50]</div><div class="line">__text:0000000101287BD4                 STP             X24, X23, [SP,#0x60+var_40]</div><div class="line">__text:0000000101287BD8                 STP             X22, X21, [SP,#0x60+var_30]</div><div class="line">__text:0000000101287BDC                 STP             X20, X19, [SP,#0x60+var_20]</div><div class="line">__text:0000000101287BE0                 STP             X29, X30, [SP,#0x60+var_10]</div><div class="line">__text:0000000101287BE4                 ADD             X29, SP, #0x60+var_10</div><div class="line">__text:0000000101287BE8                 SUB             SP, SP, #0x80</div><div class="line">__text:0000000101287BEC                 MOV             X19, X3</div><div class="line">__text:0000000101287BF0                 MOV             X22, X0</div><div class="line">__text:0000000101287BF4                 MOV             W25, #0x100000</div><div class="line">__text:0000000101287BF8                 MOVK            W25, #1</div><div class="line">__text:0000000101287BFC                 MOV             X0, X2</div><div class="line">__text:0000000101287C00                 BL              _objc_retain</div><div class="line">__text:0000000101287C04                 MOV             X28, X0</div><div class="line">__text:0000000101287C08                 MOV             X0, X19</div><div class="line">__text:0000000101287C0C                 BL              _objc_retain</div><div class="line">__text:0000000101287C10                 MOV             X20, X0</div><div class="line">__text:0000000101287C14                 STR             X20, [SP,#0xE0+var_98]</div><div class="line">__text:0000000101287C18                 ADRP            X8, #selRef_row@PAGE</div><div class="line">__text:0000000101287C1C                 LDR             X1, [X8,#selRef_row@PAGEOFF]</div><div class="line">__text:0000000101287C20                 BL              _objc_msgSend</div><div class="line">__text:0000000101287C24                 MOV             X26, X0</div><div class="line">__text:0000000101287C28                 ADRP            X8, #selRef_section@PAGE</div><div class="line">__text:0000000101287C2C                 LDR             X19, [X8,#selRef_section@PAGEOFF]</div><div class="line">__text:0000000101287C30                 MOV             X0, X20</div><div class="line">__text:0000000101287C34                 MOV             X1, X19</div><div class="line">__text:0000000101287C38                 BL              _objc_msgSend</div><div class="line">__text:0000000101287C3C                 STR             X0, [SP,#0xE0+var_A8]</div><div class="line">__text:0000000101287C40                 MOV             X0, X20</div><div class="line">__text:0000000101287C44                 MOV             X1, X19</div><div class="line">__text:0000000101287C48                 BL              _objc_msgSend</div><div class="line">__text:0000000101287C4C                 MOV             X2, X0</div><div class="line">__text:0000000101287C50                 ADRP            X8, #selRef_calcDataItemIndex_@PAGE</div><div class="line">__text:0000000101287C54                 LDR             X1, [X8,#selRef_calcDataItemIndex_@PAGEOFF]</div><div class="line">__text:0000000101287C58                 MOV             X0, X22</div><div class="line">__text:0000000101287C5C                 BL              _objc_msgSend</div><div class="line">__text:0000000101287C60                 MOV             X21, X0</div><div class="line">__text:0000000101287C64                 STR             X21, [SP,#0xE0+var_C0]</div><div class="line">__text:0000000101287C68                 ADRP            X8, #classRef_MMServiceCenter@PAGE</div><div class="line">__text:0000000101287C6C                 LDR             X0, [X8,#classRef_MMServiceCenter@PAGEOFF]</div><div class="line">__text:0000000101287C70                 ADRP            X8, #selRef_defaultCenter@PAGE</div><div class="line">__text:0000000101287C74                 LDR             X1, [X8,#selRef_defaultCenter@PAGEOFF]</div><div class="line">__text:0000000101287C78                 STR             X1, [SP,#0xE0+var_B8]</div><div class="line">__text:0000000101287C7C                 BL              _objc_msgSend</div><div class="line">__text:0000000101287C80                 MOV             X29, X29</div><div class="line">__text:0000000101287C84                 BL              _objc_retainAutoreleasedReturnValue</div><div class="line">__text:0000000101287C88                 MOV             X19, X0</div><div class="line">__text:0000000101287C8C                 ADRP            X8, #classRef_WCFacade@PAGE</div><div class="line">__text:0000000101287C90                 LDR             X0, [X8,#classRef_WCFacade@PAGEOFF]</div><div class="line">__text:0000000101287C94                 ADRP            X8, #selRef_class@PAGE</div><div class="line">__text:0000000101287C98                 LDR             X1, [X8,#selRef_class@PAGEOFF]</div><div class="line">__text:0000000101287C9C                 STR             X1, [SP,#0xE0+var_B0]</div><div class="line">__text:0000000101287CA0                 BL              _objc_msgSend</div><div class="line">__text:0000000101287CA4                 MOV             X2, X0</div><div class="line">__text:0000000101287CA8                 ADRP            X8, #selRef_getService_@PAGE</div><div class="line">__text:0000000101287CAC                 LDR             X1, [X8,#selRef_getService_@PAGEOFF]</div><div class="line">__text:0000000101287CB0                 STR             X1, [SP,#0xE0+var_A0]</div><div class="line">__text:0000000101287CB4                 MOV             X0, X19</div><div class="line">__text:0000000101287CB8                 BL              _objc_msgSend</div><div class="line">__text:0000000101287CBC                 MOV             X29, X29</div><div class="line">__text:0000000101287CC0                 BL              _objc_retainAutoreleasedReturnValue</div><div class="line">__text:0000000101287CC4                 MOV             X20, X0</div><div class="line">__text:0000000101287CC8                 ADRP            X8, #selRef_getTimelineDataItemOfIndex_@PAGE</div><div class="line">__text:0000000101287CCC                 LDR             X1, [X8,#selRef_getTimelineDataItemOfIndex_@PAGEOFF]</div><div class="line">__text:0000000101287CD0                 STR             X1, [SP,#0xE0+var_C8]</div><div class="line">__text:0000000101287CD4                 MOV             X2, X21</div><div class="line">__text:0000000101287CD8                 BL              _objc_msgSend</div><div class="line">__text:0000000101287CDC                 MOV             X29, X29</div><div class="line">__text:0000000101287CE0                 BL              _objc_retainAutoreleasedReturnValue</div><div class="line">__text:0000000101287CE4                 MOV             X21, X0</div><div class="line">__text:0000000101287CE8                 MOV             X0, X20</div><div class="line">......</div></pre></td></tr></table></figure>
<p><code>selRef_getTimelineDataItemOfIndex_</code>传入的参数是x2，可以看到传值给x2的x21是函数<code>selRef_calcDataItemIndex_</code>的返回值，是一个unsigned long数据类型。继续分析，<code>selRef_getTimelineDataItemOfIndex_</code>函数的调用者是上一步<code>selRef_getService_</code>的返回值，经过断点分析发现是一个<code>WCFacade</code>对象。整理一下<code>selRef_getTimelineDataItemOfIndex_</code>的调用：<br><strong>调用者是<code>selRef_getService_</code>的返回值；参数是<code>selRef_calcDataItemIndex_</code>的返回值</strong><br>下面把目光转向那两个函数，用相同的原理分析它们各自怎么实现调用  </p>
<ol>
<li>先看<code>selRef_getService_</code>：<br>在0x101287CB4这个位置可以发现，这个函数的调用者是从通过x19 MOV的，打印x19发现是一个<code>MMServiceCenter</code>对象，往上找x19是在0x101287C88这个位置赋值的，结果很清晰x19是<code>[MMServiceCenter defaultCenter]</code>的返回值。<br>在0x101287CA4位置可以找到传入的参数x2，往上分析可以看出来它的参数是<code>[WCFacade class]</code>的返回值。  </li>
<li>接着找<code>selRef_calcDataItemIndex_</code>：<br>在0x101287C58的位置找到它的调用者x0，x0通过x22赋值，继续向上寻找，发现在最上面0x101287BF0的位置，x22是x0赋值的，一开始的x0就是<code>WCTimeLineViewController</code>自身。<br>在0x101287C4C位置发现传入的参数来自x2,x2是通过上一步<code>selRef_section</code>函数的返回值x0赋值的，在0x101287C30位置可以发现<code>selRef_section</code>函数的调用者是x20赋值的，如下图所示，最终找到<code>selRef_section</code>的调用者是x3<br><img src="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91-selRef_section%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85.png" alt="selRef_section函数的调用者"><br>x3就是函数<code>WCTimeLineViewController - (void)genNormalCell:(id) indexPath:(id)</code>的第二个参数indexPath,，所以<code>selRef_calcDataItemIndex_</code>的参数是<code>[IndexPath section]</code>。<br>对上面的分析结果做个梳理：<br>因此<code>getTimelineDataItemOfIndex:</code>的调用者可以通过</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[[MMServiceCenter defaultCenter] getService:[WCFacade class]]</div></pre></td></tr></table></figure>
<p>来获得,它的参数可以通过下面的函数获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[WCTimeLineViewController calcDataItemIndex:[indexPath section]]</div></pre></td></tr></table></figure>
<p>总感觉还少点什么？indexPath我们还没拿到呢！下一步就是拿到indexPath,这个就比较简单了，因为我们位于<code>[WCContentItemViewTemplateNewSight onLongTouch]</code>中，所以可以通过<code>[self nextResponder]</code>依次拿到MMTableViewCell、MMTableView和WCTimeLineViewController，再通过<code>[MMTableView indexPathForCell:MMTableViewCell]</code>拿到indexPath。<br>做完这些，已经拿到WCDataItem对象，接下来的重点要放在WCDataItem上，最终要获取我们要的小视频。到这个类的头文件中找线索，因为视频是下载完成后才能播放的，所以这里应该拿到了视频的路径，所以要注意url和path相关的属性或方法，然后找到下面这几个嫌疑对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@property(retain, nonatomic) NSString *sourceUrl2; </div><div class="line">@property(retain, nonatomic) NSString *sourceUrl; </div><div class="line">- (id)descriptionForKeyPaths;</div><div class="line">- (id)keyPaths;</div></pre></td></tr></table></figure>
<p>回到LLDB中，用断点打印这些值，看看有什么。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">(lldb) po [$x0 keyPaths]</div><div class="line">&lt;__NSArrayI 0x15f74e9d0&gt;(</div><div class="line">	tid,</div><div class="line">	username,</div><div class="line">	createtime,</div><div class="line">	commentUsers,</div><div class="line">	contentObj</div><div class="line">)</div><div class="line">(lldb) po [$x0 descriptionForKeyPaths]</div><div class="line">Class name: WCDataItem, addr: 0x15f5f03b0</div><div class="line">tid: 12393001887435993280</div><div class="line">username: wxid_z8twcz4o18fg12</div><div class="line">createtime: 1477360950</div><div class="line">commentUsers: (</div><div class="line">)</div><div class="line">contentObj: &lt;WCContentItem: 0x15f57d000&gt;</div><div class="line">(lldb) po [$x0 sourceUrl]</div><div class="line"> nil</div><div class="line">(lldb) po [$x0 sourceUrl2]</div><div class="line"> nil</div></pre></td></tr></table></figure>
<p>并没有什么有价值的线索，不过注意到WCDataItem里面有一个WCContentItem，看来只能从这儿入手了，去看一下头文件吧！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@property(retain, nonatomic) NSString *linkUrl; </div><div class="line">@property(retain, nonatomic) NSString *linkUrl2; </div><div class="line">@property(retain, nonatomic) NSMutableArray *mediaList;</div></pre></td></tr></table></figure>
<p>在LLDB打印出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(lldb) po [[$x0 valueForKey:@&quot;contentObj&quot;] linkUrl]</div><div class="line">https://support.weixin.qq.com/cgi-bin/mmsupport-bin/readtemplate?t=page/common_page__upgrade&amp;v=1</div><div class="line">(lldb) po [[$x0 valueForKey:@&quot;contentObj&quot;] linkUrl2]</div><div class="line"> nil</div><div class="line">(lldb) po [[$x0 valueForKey:@&quot;contentObj&quot;] mediaList]</div><div class="line">&lt;__NSArrayM 0x15f985e10&gt;(</div><div class="line">&lt;WCMediaItem: 0x15dfebdf0&gt;</div><div class="line">)</div></pre></td></tr></table></figure>
<p>mediaList数组里面有一个WCMediaItem对象，Media一般用来表示视频和音频，大胆猜测就是它了！赶紧找到头文件搜索一遍。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@property(retain, nonatomic) WCUrl *dataUrl;</div><div class="line">- (id)pathForData;</div><div class="line">- (id)pathForSightData;</div><div class="line">- (id)pathForTempAttachVideoData;</div><div class="line">- (id)videoStreamForData;</div></pre></td></tr></table></figure>
<p>上面这些属性和方法中<code>pathForSightData</code>是最有可能拿到小视频路径的，继续验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(lldb) po [[[[$x0 valueForKey:@&quot;contentObj&quot;] mediaList] lastObject] dataUrl]</div><div class="line">type[1], url[http://vweixinf.tc.qq.com/102/20202/snsvideodownload?filekey=30270201010420301e020166040253480410d14adcddf086f4e131d11a5b1cca1bdf0203039fa00400&amp;bizid=1023&amp;hy=SH&amp;fileparam=302c0201010425302302040fde55e20204580ebd3602024eea02031e8d7d02030f42400204d970370a0201000400], enckey[0], encIdx[-1], token[]</div><div class="line">(lldb) po [[[[$x0 valueForKey:@&quot;contentObj&quot;] mediaList] lastObject] pathForData]</div><div class="line">/var/mobile/Containers/Data/Application/7C3A6322-1F57-49A0-ACDE-6EF0ED74D137/Library/WechatPrivate/6f696a1b596ce2499419d844f90418aa/wc/media/5/53/8fb0cdd77208de5b56169fb3458b45</div><div class="line">(lldb) po [[[[$x0 valueForKey:@&quot;contentObj&quot;] mediaList] lastObject] pathForSightData]</div><div class="line">/var/mobile/Containers/Data/Application/7C3A6322-1F57-49A0-ACDE-6EF0ED74D137/Library/WechatPrivate/6f696a1b596ce2499419d844f90418aa/wc/media/5/53/8fb0cdd77208de5b56169fb3458b45.mp4</div><div class="line">(lldb) po [[[[$x0 valueForKey:@&quot;contentObj&quot;] mediaList] lastObject] pathForAttachVideoData]</div><div class="line"> nil</div><div class="line">(lldb) po [[[[$x0 valueForKey:@&quot;contentObj&quot;] mediaList] lastObject] videoStreamForData]</div><div class="line"> nil</div></pre></td></tr></table></figure>
<p>拿到小视频的网络url和本地路径了！这里可以用iFunBox或者scp从沙盒拷贝这个文件看看是不是这个cell应该播放的小视频。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LeonLei-MBP:~ gaoshilei$ scp root@192.168.0.115:/var/mobile/Containers/Data/Application/7C3A6322-1F57-49A0-ACDE-6EF0ED74D137/Library/WechatPrivate/6f696a1b596ce2499419d844f90418aa/wc/media/5/53/8fb0cdd77208de5b56169fb3458b45.mp4 Desktop/</div><div class="line">8fb0cdd77208de5b56169fb3458b45.mp4                100%  232KB 231.9KB/s   00:00</div></pre></td></tr></table></figure>
<p>用QuickTime打开发现果然是我们要寻找的小视频。再验证一下url是否正确，把上面打印的dataUrl在浏览器中打开，发现也是这个小视频。分析这个类可以得出下面的结论：  </p>
<ul>
<li><strong>dataUrl：</strong>小视频的网络url</li>
<li><strong>pathForData：</strong>小视频的本地路径</li>
<li><strong>pathForSightData：</strong>小视频的本地路径（不带后缀）</li>
</ul>
<p>至此小视频的路径和取得方式分析已经完成，要实现转发还要继续分析微信的朋友圈发布。</p>
<h2 id="二、实现转发功能"><a href="#二、实现转发功能" class="headerlink" title="二、实现转发功能"></a>二、实现转发功能</h2><h3 id="1-“走进死胡同”"><a href="#1-“走进死胡同”" class="headerlink" title="1.“走进死胡同”"></a>1.“走进死胡同”</h3><blockquote>
<p>   这节是我在找小视频转发功能时走的弯路，扒到最后并没有找到实现方法，不过也提供了一些逆向中常用的思路和方法，不想看的可以跳到第二节。  </p>
</blockquote>
<h4 id="（1）找到小视频拍摄完成调用的方法名称"><a href="#（1）找到小视频拍摄完成调用的方法名称" class="headerlink" title="（1）找到小视频拍摄完成调用的方法名称"></a>（1）找到小视频拍摄完成调用的方法名称</h4><p>打开小视频的拍摄界面，用cycript注入，我们要找到发布小视频的方法是哪个，然后查看当前的窗口有哪些window（因为小视频的拍摄并不是在UIApplication的keyWindow中进行的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cy# [UIApp windows].toString()</div><div class="line">(</div><div class="line">    &quot;&lt;iConsoleWindow: 0x125f75e20; baseClass = UIWindow; frame = (0 0; 320 568); autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x125f77b70&gt;; layer = &lt;UIWindowLayer: 0x125df4810&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;SvrErrorTipWindow: 0x127414d40; baseClass = UIWindow; frame = (0 64; 320 45); hidden = YES; gestureRecognizers = &lt;NSArray: 0x12740d930&gt;; layer = &lt;UIWindowLayer: 0x1274030b0&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;MMUIWindow: 0x127796440; baseClass = UIWindow; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x1278083c0&gt;; layer = &lt;UIWindowLayer: 0x127796750&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;UITextEffectsWindow: 0x1270e0d40; frame = (0 0; 320 568); opaque = NO; autoresize = W+H; layer = &lt;UIWindowLayer: 0x1270b4ba0&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;NewYearActionSheet: 0x127797e10; baseClass = UIWindow; frame = (0 0; 320 568); hidden = YES; userInteractionEnabled = NO; layer = &lt;UIWindowLayer: 0x1277d5490&gt;&gt;&quot;</div><div class="line">)</div></pre></td></tr></table></figure>
<p>发现当前页面一共有5个window，其中MMUIWindow是小视频拍摄所在的window，打印它的UI树状结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cy# [#0x127796440 recursiveDescription]</div></pre></td></tr></table></figure>
<p>打印结果比较长，不贴了。找到这个按钮是拍摄小视频的按钮</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">|    |    |    |    |    | &lt;UIButton: 0x1277a9d70; frame = (89.5 368.827; 141 141); opaque = NO; gestureRecognizers = &lt;NSArray: 0x1277aaeb0&gt;; layer = &lt;CALayer: 0x1277a9600&gt;&gt;</div><div class="line">|    |    |    |    |    |    | &lt;UIView: 0x1277aa0a0; frame = (0 0; 141 141); userInteractionEnabled = NO; tag = 252707333; layer = &lt;CALayer: 0x1277aa210&gt;&gt;</div><div class="line">|    |    |    |    |    |    |    | &lt;UIImageView: 0x1277aa2e0; frame = (0 0; 141 141); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x1277aa490&gt;&gt;</div></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cy# [#0x1277a9d70 setHidden:YES]</div></pre></td></tr></table></figure>
<p>发现拍摄的按钮消失了，验证了我的猜想。寻找按钮的响应事件，可以通过target来寻找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cy# [#0x1277a9d70 allTargets]</div><div class="line">[NSSet setWithArray:@[#&quot;&lt;MainFrameSightViewController: 0x1269a4600&gt;&quot;]]]</div><div class="line">cy# [#0x1277a9d70 allControlEvents]</div><div class="line">193</div><div class="line">cy# [#0x1277a9d70 actionsForTarget:#0x1269a4600 forControlEvent:193]</div><div class="line">null</div></pre></td></tr></table></figure>
<p>发现按钮并没有对应的action，这就奇怪了！UIButton必须要有target和action，不然这个Button不能响应事件。我们试试其他的ControlEvent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cy# [#0x1277a9d70 actionsForTarget:#0x1269a4600 forControlEvent:UIControlEventTouchDown]</div><div class="line">@[&quot;btnPress&quot;]</div><div class="line">cy# [#0x1277a9d70 actionsForTarget:#0x1269a4600 forControlEvent:UIControlEventTouchUpOutside]</div><div class="line">@[&quot;btnRelease&quot;]</div><div class="line">cy# [#0x1277a9d70 actionsForTarget:#0x1269a4600 forControlEvent:UIControlEventTouchUpInside]</div><div class="line">@[&quot;btnRelease&quot;]</div></pre></td></tr></table></figure>
<p>结果发现这三个ContrlEvent有对应的action，我们再看看这三个枚举的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">typedef enum UIControlEvents : NSUInteger &#123;</div><div class="line">    UIControlEventTouchDown = 1 &lt;&lt;  0,</div><div class="line">    UIControlEventTouchDownRepeat = 1 &lt;&lt;  1,</div><div class="line">    UIControlEventTouchDragInside = 1 &lt;&lt;  2,</div><div class="line">    UIControlEventTouchDragOutside = 1 &lt;&lt;  3,</div><div class="line">    UIControlEventTouchDragEnter = 1 &lt;&lt;  4,</div><div class="line">    UIControlEventTouchDragExit = 1 &lt;&lt;  5,</div><div class="line">    UIControlEventTouchUpInside = 1 &lt;&lt;  6,</div><div class="line">    UIControlEventTouchUpOutside = 1 &lt;&lt;  7,</div><div class="line">    UIControlEventTouchCancel = 1 &lt;&lt;  8,</div><div class="line">	......</div><div class="line">&#125; UIControlEvents;</div></pre></td></tr></table></figure>
<p>可以看出来UIControlEventTouchDown对应1，UIControlEventTouchUpInside对应128，UIControlEventTouchUpOutside对应64，三者相加正好193！原来调用<code>[#0x1277a9d70 allControlEvents]</code>的时候返回的应该是枚举，有多个枚举则把它们的值相加，是不是略坑？我也是这样觉得的！刚才我们把三种ControlEvent对应的action都打印出来了，继续LLDB+IDA进行动态分析。</p>
<h4 id="（2）找到小视频拍摄完成跳转到发布界面的方法"><a href="#（2）找到小视频拍摄完成跳转到发布界面的方法" class="headerlink" title="（2）找到小视频拍摄完成跳转到发布界面的方法"></a>（2）找到小视频拍摄完成跳转到发布界面的方法</h4><p>因为要找到小视频发布的方法，所以对应的<code>btnPress</code>函数我们并不关心，把重点放在<code>btnRelease</code>上面，拍摄按钮松开后就会调用的方法。在IDA中找到这个方法<br><img src="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91-btnRelease.png" alt="MainFrameSightViewController - (void)btnRelease"><br>找到之后下个断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(lldb) br s -a 0xac000+0x10209369C</div><div class="line">Breakpoint 4: where = WeChat`___lldb_unnamed_symbol108894$$WeChat + 32, address = 0x000000010213f69c</div><div class="line">Process 3813 stopped</div><div class="line">* thread #1: tid = 0xf1ef0, 0x000000010213f69c WeChat`___lldb_unnamed_symbol108894$$WeChat + 32, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 4.1</div><div class="line">    frame #0: 0x000000010213f69c WeChat`___lldb_unnamed_symbol108894$$WeChat + 32</div><div class="line">WeChat`___lldb_unnamed_symbol108894$$WeChat:</div><div class="line">-&gt;  0x10213f69c &lt;+32&gt;: bl     0x1028d0b60               ; symbol stub for: objc_msgSend</div><div class="line">    0x10213f6a0 &lt;+36&gt;: cmp    w0, #2                    ; =2 </div><div class="line">    0x10213f6a4 &lt;+40&gt;: b.ne   0x10213f6dc               ; &lt;+96&gt;</div><div class="line">    0x10213f6a8 &lt;+44&gt;: adrp   x8, 5489</div></pre></td></tr></table></figure>
<p>用手机拍摄小视频然后松开，触发了断点，说明我们的猜想是正确的。继续分析发现代码是从上图的右边走的，看了一下没有什么方法是跳转到发布视频的，不过仔细看一下有一个block，是系统的延时block，位置在0x102093760。然后我们跟着断点进去，在0x1028255A0跳转到x16所存的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(lldb) si</div><div class="line">Process 3873 stopped</div><div class="line">* thread #1: tid = 0xf62c4, 0x00000001028d9598 WeChat`dispatch_after, queue = &apos;com.apple.main-thread&apos;, stop reason = instruction step into</div><div class="line">    frame #0: 0x00000001028d9598 WeChat`dispatch_after</div><div class="line">WeChat`dispatch_after:</div><div class="line">-&gt;  0x1028d9598 &lt;+0&gt;: adrp   x16, 1655</div><div class="line">    0x1028d959c &lt;+4&gt;: ldr    x16, [x16, #1056]</div><div class="line">    0x1028d95a0 &lt;+8&gt;: br     x16</div><div class="line"></div><div class="line">WeChat`dispatch_apply:</div><div class="line">    0x1028d95a4 &lt;+0&gt;: adrp   x16, 1655</div><div class="line">(lldb) po $x2</div><div class="line">&lt;__NSStackBlock__: 0x16fd49f88&gt;</div></pre></td></tr></table></figure>
<p>发现传入的参数x2是一个block，我们再回顾一下dispatch_after函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void dispatch_after(dispatch_time_t when, dispatch_queue_t queue, dispatch_block_t block);</div></pre></td></tr></table></figure>
<p>这个函数有三个参数，分别是dispatch_time_t、dispatch_queue_t、dispatch_block_t，那这里打印的x2就是要传入的block，所以我们猜测拍摄完小视频会有一个延时，然后执行刚才传入的block，所以x2中肯定有其他方法调用，下一步就是要知道这个block的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) memory read --size 8 --format x 0x16fd49f88</div><div class="line">0x16fd49f88: 0x000000019f8fd218 0x00000000c2000000</div><div class="line">0x16fd49f98: 0x000000010214777c 0x0000000102fb0e60</div><div class="line">0x16fd49fa8: 0x000000015da32600 0x000000015ea1a430</div><div class="line">0x16fd49fb8: 0x000000015cf5fee0 0x000000016fd49ff0</div></pre></td></tr></table></figure>
<p>0x000000010214777c就是block所在的位置，当然要减掉当前WeChat的ASLR偏移，最终在IDA中的地址为0x10209377C，突然发现这就是<code>btnRelease</code>的子程序sub_10209377C。这个子程序非常简单，只有一个方法<code>selRef_logicCheckState_</code>有可能是我们的目标。先看看这个方法是谁调用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(lldb) br s -a 0xb4000+0x1020937BC</div><div class="line">......</div><div class="line">Process 3873 stopped</div><div class="line">* thread #1: tid = 0xf62c4, 0x00000001021477bc WeChat`___lldb_unnamed_symbol108895$$WeChat + 64, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 3.1</div><div class="line">    frame #0: 0x00000001021477bc WeChat`___lldb_unnamed_symbol108895$$WeChat + 64</div><div class="line">WeChat`___lldb_unnamed_symbol108895$$WeChat:</div><div class="line">-&gt;  0x1021477bc &lt;+64&gt;: adrp   x8, 5489</div><div class="line">    0x1021477c0 &lt;+68&gt;: ldr    x1, [x8, #1552]</div><div class="line">    0x1021477c4 &lt;+72&gt;: orr    w2, wzr, #0x1</div><div class="line">    0x1021477c8 &lt;+76&gt;: ldp    x29, x30, [sp, #16]</div><div class="line">(lldb) po $x0</div><div class="line">&lt;MainFrameSightViewController: 0x15d1f0c00&gt;</div></pre></td></tr></table></figure>
<p>发现还是MainFrameSightViewController这个对象调用的，那<code>selRef_logicCheckState_</code>肯定也在这个类的头文件中，寻找一下果然发现了  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)logicCheckState:(int)arg1;</div></pre></td></tr></table></figure>
<p>在IDA左侧窗口中寻找[MainFrameSightViewController logicCheckState:]，发现这个方法超级复杂，逻辑太多了，不着急慢慢捋。<br>在0x102094D6C位置我们发现一个switch jump，思路就很清晰了，我们只要找到小视频拍摄完成的这条线往下看就行了，LLDB来帮忙看看走的那条线。在0x102094D6C位置下个断点，这个断点在拍摄小视频的时候会多次触发，可以在拍摄之前把断点dis掉，拍摄松手之前再启用断点，打印此时的x8值  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x $x8</div><div class="line">(unsigned long) $38 = 0x0000000102174e10</div></pre></td></tr></table></figure>
<p>x8是一个指针，它指向的地址是0x102174e10，用这个地址减去当前ASLR的偏移就可以找到在IDA中的基地址，发现是0x102094E10，拍摄完成的逻辑处理这条线找到了，一直走到0x102094E24位置之后跳转0x1020951C4，这个分支的内容较少，里面有三个函数  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">loc_1020951C4</div><div class="line">ADRP            X8, #selRef_hideTips@PAGE</div><div class="line">LDR             X1, [X8,#selRef_hideTips@PAGEOFF]</div><div class="line">MOV             X0, X19</div><div class="line">BL              _objc_msgSend</div><div class="line">ADRP            X8, #selRef_finishWriter@PAGE</div><div class="line">LDR             X1, [X8,#selRef_finishWriter@PAGEOFF]</div><div class="line">MOV             X0, X19</div><div class="line">BL              _objc_msgSend</div><div class="line">ADRP            X8, #selRef_turnCancelBtnForFinishRecording@PAGE</div><div class="line">LDR             X1, [X8,#selRef_turnCancelBtnForFinishRecording@PAGEOFF]</div><div class="line">MOV             X0, X19</div><div class="line">BL              _objc_msgSend</div><div class="line">B               loc_102095288</div></pre></td></tr></table></figure>
<p>其中<code>selRef_finishWriter</code>和<code>selRef_turnCancelBtnForFinishRecording</code>需要重点关注，这两个方法看上去都是小视频录制结束的意思，线索极有可能就在这两个函数中。通过查看调用者发现这两个方法都属于MainFrameSightViewController，继续在IDA中查看这两个方法。在<code>selRef_finishWriter</code>中靠近末尾0x102094248的位置发现一个方法名叫做<code>f_switchToSendingPanel</code>，下个断点，然后拍摄视频，发现这个方法并没有被触发。应该不是通过这个方法调用发布界面的，继续回到<code>selRef_finishWriter</code>方法中；在0x1020941DC的位置调用方法<code>selRef_stopRecording</code>，打印它的调用者发现这个方法属于<code>SightFacade</code>，继续在IDA中寻找这个方法的实现。在这个方法的0x101F9BED4位置又调用了<code>selRef_stopRecord</code>，同样打印调用者发现这个方法属于SightCaptureLogicF4，有点像剥洋葱，继续在寻找这个方法的实现。在这个方法内部0x101A98778位置又调用了<code>selRef_finishWriting</code>，同样的原理找到这个方法是属于SightMovieWriter。已经剥了3层了，继续往下：<br>在<code>SightMovieWriter - (void)finishWriting</code>中的0x10261D004位置分了两条线，这个位置下个断点，然后拍摄完小视频触发断点，打印x19的值  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) po $x19</div><div class="line">&lt;OS_dispatch_queue: CAPTURE.CALLBACK[0x13610bcd0] = &#123; xrefcnt = 0x4, refcnt = 0x4, suspend_cnt = 0x0, locked = 1, target = com.apple.root.default-qos.overcommit[0x1a0aa3700], width = 0x0, running = 0x0, barrier = 1 &#125;&gt;</div></pre></td></tr></table></figure>
<p>所以代码不会跳转到loc_10261D054而是走的左侧，在左侧的代码中发现启用了一个block，这个block是子程序sub_10261D0AC，地址为0x10261D0AC，找到这个地址，结构如下图所示：<br><img src="http://oeat6c2zg.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91sub_10261D0AC.png" alt="sub_10261D0AC"><br>可以看出来主要分两条线，我们在第一个方框的末尾也就是0x10261D108位置下个断点，等拍摄完毕触发断点之后打印x0的值为1，这里的汇编代码为  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__text:000000010261D104                 CMP             X0, #2</div><div class="line">__text:000000010261D108                 B.EQ            loc_10261D234</div></pre></td></tr></table></figure>
<p>B.EQ是在上一步的结果为0才会跳转到loc_10261D234，但是这里的结果是不为0的，将x0的值改为2让上一步的结果为0  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) po $x0</div><div class="line">1</div><div class="line">(lldb) register write $x0 2</div><div class="line">(lldb) po $x0</div><div class="line">2</div></pre></td></tr></table></figure>
<p>此时放开断点，等待跳转到小视频发布界面，结果是一直卡在这个界面没有任何反应，所以猜测实现跳转的逻辑应该在右边的那条线，继续顺着右边的线寻找：<br>在右侧0x10261D3AC位置发现调用了下面的这个方法  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)finishWritingWithCompletionHandler:(void (^)(void))handler;</div></pre></td></tr></table></figure>
<p>这个方法是系统提供的AVAssetWriter里面的方法，在视频写入完成之后要做的操作，这个里是要传入一个block的，因为只有一个参数所以对应的变量是x2，打印x2的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(lldb) po $x2</div><div class="line">&lt;__NSStackBlock__: 0x16e086c78&gt;</div><div class="line">(lldb) memory read --size 8 --format x 0x16e086c78</div><div class="line">0x16e086c78: 0x00000001a0aa5218 0x00000000c2000000</div><div class="line">0x16e086c88: 0x00000001026d94b0 0x0000000102fc98c0</div><div class="line">0x16e086c98: 0x0000000136229fd0 0x000000016e086d00</div><div class="line">0x16e086ca8: 0x00000001997f5318 0xfffffffec9e882ff</div></pre></td></tr></table></figure>
<p>并且通过栈内存找到block位置为0x10261D4B0（需要减去ASLR的偏移）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">sub_10261D4B0</div><div class="line">var_20= -0x20</div><div class="line">var_10= -0x10</div><div class="line">STP             X20, X19, [SP,#var_20]!</div><div class="line">STP             X29, X30, [SP,#0x20+var_10]</div><div class="line">ADD             X29, SP, #0x20+var_10</div><div class="line">MOV             X19, X0</div><div class="line">LDR             X0, [X19,#0x20]</div><div class="line">ADRP            X8, #selRef_stopAmr@PAGE</div><div class="line">LDR             X1, [X8,#selRef_stopAmr@PAGEOFF]</div><div class="line">BL              _objc_msgSend</div><div class="line">LDR             X0, [X19,#0x20]</div><div class="line">ADRP            X8, #selRef_compressAudio@PAGE</div><div class="line">LDR             X1, [X8,#selRef_compressAudio@PAGEOFF]</div><div class="line">LDP             X29, X30, [SP,#0x20+var_10]</div><div class="line">LDP             X20, X19, [SP+0x20+var_20],#0x20</div><div class="line">B               _objc_msgSend</div><div class="line">; End of function sub_10261D4B0</div></pre></td></tr></table></figure>
<p>只调用了两个方法，一个是<code>selRef_stopAmr</code>停止amr（一种音频格式），另一个是<code>selRef_compressAudio</code>压缩音频，拍摄完成的下一步操作应该不会放在这两个方法里面，找了这么久也没有头绪，这个路看来走不通了，不要钻牛角尖，战略性撤退寻找其他入口。<br><strong>逆向的乐趣就是一直寻找真相的路上，能体会到成功的乐趣，也有可能方向错了离真相反而越来越远，不要气馁调整方向继续前进！</strong></p>
<h3 id="2-“另辟蹊径”"><a href="#2-“另辟蹊径”" class="headerlink" title="2.“另辟蹊径”"></a>2.“另辟蹊径”</h3><blockquote>
<p>（由于微信在后台偷偷升级了，下面的内容都是微信6.3.30版本的ASLR，上面的分析基于6.3.28版本）</p>
</blockquote>
<p>注意到在点击朋友圈右上角的相机按钮底部会弹出一个Sheet，第一个就是Sight小视频，从这里入手，用cycript查看Sight按钮对应的事件是哪个  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">iPhone-5S:~ root# cycript -p &quot;WeChat&quot;</div><div class="line">cy# [UIApp windows].toString()</div><div class="line">`(</div><div class="line">    &quot;&lt;iConsoleWindow: 0x14d6ccc00; baseClass = UIWindow; frame = (0 0; 320 568); autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x14d7df110&gt;; layer = &lt;UIWindowLayer: 0x14d7d6f60&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;SvrErrorTipWindow: 0x14eaa5800; baseClass = UIWindow; frame = (0 0; 320 45); hidden = YES; gestureRecognizers = &lt;NSArray: 0x14e9e8950&gt;; layer = &lt;UIWindowLayer: 0x14e9e6510&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;UITextEffectsWindow: 0x14ec38ba0; frame = (0 0; 320 568); opaque = NO; autoresize = W+H; layer = &lt;UIWindowLayer: 0x14ec39360&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;UITextEffectsWindow: 0x14e9c67a0; frame = (0 0; 320 568); layer = &lt;UIWindowLayer: 0x14d683ff0&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;UIRemoteKeyboardWindow: 0x14f226e40; frame = (0 0; 320 568); opaque = NO; autoresize = W+H; layer = &lt;UIWindowLayer: 0x14d6f4de0&gt;&gt;&quot;,</div><div class="line">    &quot;&lt;NewYearActionSheet: 0x14f1704a0; baseClass = UIWindow; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x14ef9bf90&gt;; layer = &lt;UIWindowLayer: 0x14ef61a20&gt;&gt;&quot;</div><div class="line">)`</div><div class="line">cy# [#0x14f1704a0 recursiveDescription].toString()</div></pre></td></tr></table></figure>
<p>底部的Sheet是NewYearActionSheet，然后打印NewYearActionSheet的UI树状结构图（比较长不贴了）。然后找到Sight对应的UIButton是0x14f36d470   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cy# [#0x14f36d470 allTargets]</div><div class="line">[NSSet setWithArray:@[#&quot;&lt;NewYearActionSheet: 0x14f1704a0; baseClass = UIWindow; frame = (0 0; 320 568); gestureRecognizers = &lt;NSArray: 0x14ef9bf90&gt;; layer = &lt;UIWindowLayer: 0x14ef61a20&gt;&gt;&quot;]]]</div><div class="line">cy# [#0x14f36d470 allControlEvents]</div><div class="line">64</div><div class="line">cy# [#0x14f36d470 actionsForTarget:#0x14f1704a0 forControlEvent:64]</div><div class="line">@[&quot;OnDefaultButtonTapped:&quot;]</div></pre></td></tr></table></figure>
<p>通过UIControl的<code>actionsForTarget:forControlEvent:</code>方法可以找到按钮绑定的事件，Sight按钮的触发方法为<code>OnDefaultButtonTapped:</code>，回到IDA中在NewYearActionSheet中找到这个方法们继续往下分析只有这个方法<code>selRef_dismissWithClickedButtonIndex_animated</code>，通过打印它的调用者发现还是NewYearActionSheet，继续点进去找到<code>newYearActionSheet_clickedButtonAtIndex</code>方法，看样子不是NewYearActionSheet自己的，打印调用者x0发现它属于类WCTimeLineViewController。跟着断点走下去在0x1012B78CC位置调用了方法<code>#selRef_showSightWindowForMomentWithMask_byViewController_scene</code><br>通过观察发现这个方法的调用者是0x1012B78AC这个位置的返回值x0，这是一个类SightFacade，猜测这个方法在SightFacade里面，去头文件里找一下果然发现这个方法  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)showSightWindowForMomentWithMask:(id)arg1 byViewController:(id)arg2 scene:(int)arg3;</div></pre></td></tr></table></figure>
<p>这个方法应该就是跳转到小视频界面的方法了。下面分别打印它的参数  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(lldb) po $x2</div><div class="line">&lt;UIImage: 0x14f046660&gt;, &#123;320, 568&#125;</div><div class="line">(lldb) po $x3</div><div class="line">&lt;WCTimeLineViewController: 0x14e214800&gt;</div><div class="line">(lldb) po $x4</div><div class="line">2</div><div class="line">(lldb) po $x0</div><div class="line">&lt;SightFacade: 0x14f124b40&gt;</div></pre></td></tr></table></figure>
<p>其中x2、x3、x4分别对应三个参数，x0是调用者，跳到这个方法内部查看怎么实现的。发现在这个方法中进行了小视频拍摄界面的初始化工作，首先初始化一个MainFrameSightViewController，再创建一个UINavigationController将MainFrameSightViewController放进去，接下来初始化一个MMWindowController调用  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (id)initWithViewController:(id)arg1 windowLevel:(int)arg2;</div></pre></td></tr></table></figure>
<p>方法将UINavigationController放了进去，完成小视频拍摄界面的所有UI创建工作。<br>拍摄完成之后进入发布界面，此时用cycript找到当前的Controller是SightMomentEditViewController，由此萌生一个想法，跳过前面的拍摄界面直接进入发布界面不就可以了吗？我们自己创建一个SightMomentEditViewController然后放到UINavigationController里面，然后再将这个导航控制器放到MMWindowController里面。<strong>（这里我已经写好tweak进行了验证，具体的tweak思路编写在后文有）</strong>结果是的确可以弹出发布的界面，但是导航栏的NavgationBar遮住了原来的，整个界面是透明的，很难看，而且发布完成之后无法销毁整个MMWindowController，还是停留在发布界面。我们要的结果不是这个，不过确实有很大的收获，最起码可以直接调用发布界面了，小视频也能正常转发。我个人猜测，当前界面不能被销毁的原因是因为MMWindowController新建了一个window,它跟TimeLine所在的keyWindow不是同一个，SightMomentEditViewController的按钮触发的方法是没有办法销毁这个window的，所以有一个大胆的猜想，我直接在当前的WCTimeLineViewController上把SightMomentEditViewController展示出来不就可以了吗？  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[WCTimelineVC presentViewController:editSightVC animated:YES completion:^&#123;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>像这样展示岂不妙哉？不过通过观察SightMomentEditViewController的头文件，结合小视频发布时界面上的元素，推测创建这个控制器至少需要两个属性，一个是小视频的路径，另一个是小视频的缩略图，将这两个关键属性给了SightMomentEditViewController那么应该就可以正常展示了   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SightMomentEditViewController *editSightVC = [[%c(SightMomentEditViewController) alloc] init];</div><div class="line">NSString *localPath = [[self iOSREMediaItemFromSight] pathForSightData];</div><div class="line">UIImage *image = [[self valueForKey:@&quot;_sightView&quot;] getImage];</div><div class="line">[editSightVC setRealMoviePath:localPath];</div><div class="line">[editSightVC setMoviePath:localPath];</div><div class="line">[editSightVC setRealThumbImage:image];</div><div class="line">[editSightVC setThumbImage:image];</div><div class="line">[WCTimelineVC presentViewController:editSightVC animated:YES completion:^&#123;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>小视频的发布界面可以正常显示并且所有功能都可以正常使用，唯一的问题是返回按钮没有效果，并不能销毁SightMomentEditViewController。用cycript查看左侧按钮的actionEvent找到它的响应函数是<code>- (void)popSelf;</code>，点击左侧返回触发的是pop方法，但是这个控制器并不在navgationController里面，所以无效，我们要对这个方法进行重写  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)popSelf</div><div class="line">&#123;</div><div class="line">    [self dismissViewControllerAnimated:YES completion:^&#123;</div><div class="line"></div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此时再点击返回按钮就可以正常退出了，此外，在WCContentItemViewTemplateNewSight中发现了一个方法叫做<code>- (void)sendSightToFriend;</code>，可以直接将小视频转发给好友，至此小视频转发的功能已经找到了。</p>

      
    </div>
    
  </div>
  
    


    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/11/10/手把手教你逆向微信之朋友圈小视频转发（下）/">
                    手把手教你逆向微信之朋友圈小视频转发（下）
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/09/07/iPhone查找序列号生成函数/">
                    iPhone查找序列号生成函数
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#逆向微信朋友圈（上篇）"><span class="toc-number">2.</span> <span class="toc-text">逆向微信朋友圈（上篇）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、获取朋友圈的小视频"><span class="toc-number">2.1.</span> <span class="toc-text">一、获取朋友圈的小视频</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本文涉及到的工具"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">本文涉及到的工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、实现转发功能"><span class="toc-number">2.2.</span> <span class="toc-text">二、实现转发功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-“走进死胡同”"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.“走进死胡同”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）找到小视频拍摄完成调用的方法名称"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">（1）找到小视频拍摄完成调用的方法名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）找到小视频拍摄完成跳转到发布界面的方法"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">（2）找到小视频拍摄完成跳转到发布界面的方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-“另辟蹊径”"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.“另辟蹊径”</span></a></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"手把手教你逆向微信之朋友圈小视频转发（上）　| LeonLei的博客　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2016/11/09/手把手教你逆向微信之朋友圈小视频转发（上）/" data-title="手把手教你逆向微信之朋友圈小视频转发（上）" data-url="http://www.gaoshilei.com/2016/11/09/手把手教你逆向微信之朋友圈小视频转发（上）/"></div>
    <script>
        var duoshuoQuery = {short_name:"leonlei"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = 'http://oeat6c2zg.bkt.clouddn.com/embed.js';
	    s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/11/10/手把手教你逆向微信之朋友圈小视频转发（下）/" title="上一篇: 手把手教你逆向微信之朋友圈小视频转发（下）">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/09/07/iPhone查找序列号生成函数/" title="下一篇: iPhone查找序列号生成函数">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/Static Library/">iOS静态库SDK制作（包含第三方静态库）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/10/手把手教你逆向微信之朋友圈小视频转发（下）/">手把手教你逆向微信之朋友圈小视频转发（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/09/手把手教你逆向微信之朋友圈小视频转发（上）/">手把手教你逆向微信之朋友圈小视频转发（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/07/iPhone查找序列号生成函数/">iPhone查找序列号生成函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/08/dumpdecrypted给App砸壳/">dumpdecrypted给App砸壳</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/VPS/">VPS搭建高速VPN服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/Xcode编译报错Undefined symbols解决方案/">Xcode编译报错Undefined symbols解决方案</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016 LeonLei
            </div>
            <div class="footer-right">
               powered by  <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a> <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>

    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>