<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><link href="/css/hexo-tag-common.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="LeonLei"><meta name="copyright" content="LeonLei"><meta name="generator" content="Hexo 6.3.0"><meta name="theme" content="hexo-theme-yun"><title>【转载】黑科技：把第三方iOS应用转成动态库 | 路是月的痕</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"www.gaoshilei.com","root":"/","title":"大石头的小站","version":"1.10.7","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="路是月的痕" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="文章转载自杨君的小黑屋，对排版进行了一些调整 前言本文会介绍一个自己写的工具，能够把第三方iOS应用转成动态库，并加载到自己的App中，文章最后会以支付宝为例，展示如何调用其中的C函数和OC方法。工具开源地址：https:&#x2F;&#x2F;github.com&#x2F;tobefuturer&#x2F;app2dylib">
<meta property="og:type" content="article">
<meta property="og:title" content="【转载】黑科技：把第三方iOS应用转成动态库">
<meta property="og:url" content="http://www.gaoshilei.com/iOSAppToLibrary/index.html">
<meta property="og:site_name" content="路是月的痕">
<meta property="og:description" content="文章转载自杨君的小黑屋，对排版进行了一些调整 前言本文会介绍一个自己写的工具，能够把第三方iOS应用转成动态库，并加载到自己的App中，文章最后会以支付宝为例，展示如何调用其中的C函数和OC方法。工具开源地址：https:&#x2F;&#x2F;github.com&#x2F;tobefuturer&#x2F;app2dylib">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%BA%94%E7%94%A8%E4%B8%8E%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%B4%E9%83%A8%E6%96%87%E4%BB%B6%E4%B8%8D%E5%90%8C.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%9A%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%9E%8B.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%9A%E5%87%BA%E4%B8%80%E4%B8%AA%20PAGEZERO%E6%AE%B5.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-PAGEZERO%E6%AE%B5%E4%BF%AE%E6%94%B9%E5%89%8D.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-PAGEZERO%E6%AE%B5%E4%BF%AE%E6%94%B9%E5%90%8E.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E5%81%8F%E7%A7%BB%E9%87%8F.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E4%B8%AD%E6%8C%87%E9%92%88%E5%87%8F0xFFFFC000.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20opcode.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E4%BF%AE%E6%94%B9%E7%AC%A6%E5%8F%B7%E8%A1%A8.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E5%BF%B5%E8%8C%9Ctwitter.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20Xcode%E6%96%B0%E5%BB%BA%E5%B7%A5%E7%A8%8B.jpg">
<meta property="og:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C.jpg">
<meta property="article:published_time" content="2016-10-15T16:00:00.000Z">
<meta property="article:modified_time" content="2023-10-20T12:32:48.013Z">
<meta property="article:author" content="LeonLei">
<meta property="article:tag" content="动态库">
<meta property="article:tag" content="黑科技">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%BA%94%E7%94%A8%E4%B8%8E%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB.jpg"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="LeonLei"><img width="96" loading="lazy" src="/images/avatar.png" alt="LeonLei"></a><div class="site-author-name"><a href="/about/">LeonLei</a></div><span class="site-name">路是月的痕</span><sub class="site-subtitle">代码略懂，精通LOL</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">15</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">29</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">有什么用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%92%8C%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%BC%82%E5%90%8C"><span class="toc-number">3.</span> <span class="toc-text">应用和动态库的异同</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%90%8C%E7%82%B9%EF%BC%9A"><span class="toc-number">3.1.</span> <span class="toc-text">相同点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%82%B9%EF%BC%9A"><span class="toc-number">3.2.</span> <span class="toc-text">不同点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">4.</span> <span class="toc-text">实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">修改文件类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%89%80%E6%9C%89%E6%AE%B5%E7%9A%84%E5%9C%B0%E5%9D%80%E9%83%BD%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.	所有段的地址都要重新计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AF%B9%E5%8A%A8%E6%80%81%E5%BA%93%E8%BF%9B%E8%A1%8Crebase%E6%93%8D%E4%BD%9C"><span class="toc-number">4.1.2.</span> <span class="toc-text">2.	对动态库进行rebase操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E5%8E%BB%E6%8E%89PAGEZERO%E8%BF%99%E4%B8%AA%E6%AE%B5"><span class="toc-number">4.1.3.</span> <span class="toc-text">3.	为什么不能直接去掉PAGEZERO这个段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text">修改符号表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C"><span class="toc-number">5.</span> <span class="toc-text">实际效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8A%8A%E6%94%AF%E4%BB%98%E5%AE%9Darm64%E7%A0%B8%E5%A3%B3%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8F%90%E5%8F%96%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%8C%E7%94%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%B7%A5%E5%85%B7%E6%8A%8A%E6%94%AF%E4%BB%98%E5%AE%9D%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93"><span class="toc-number">5.1.</span> <span class="toc-text">2.	把支付宝arm64砸壳，然后提取可执行文件，用上面的工具把支付宝的可执行文件转成动态库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%94%A8-Xcode-%E6%96%B0%E5%BB%BA%E5%B7%A5%E7%A8%8B%EF%BC%8C%E5%B9%B6%E6%8A%8A%E6%96%B0%E7%94%9F%E6%88%90%E7%9A%84dylib%E6%8B%96%E8%BF%9B%E5%8E%BB%EF%BC%8C%E8%B0%83%E6%95%B4%E5%A5%BD%E5%90%84%E9%A1%B9%E8%AE%BE%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">3.	用 Xcode 新建工程，并把新生成的dylib拖进去，调整好各项设置.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8%E5%8A%A8%E6%80%81%E5%BA%93%E9%87%8C%E7%9A%84%E6%96%B9%E6%B3%95%E5%91%A2%EF%BC%9F"><span class="toc-number">5.3.</span> <span class="toc-text">4.	怎么调用动态库里的方法呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">关于绕过检测代码</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://www.gaoshilei.com/iOSAppToLibrary/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="LeonLei"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="路是月的痕"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">【转载】黑科技：把第三方iOS应用转成动态库<a class="post-edit-link" href="https://github.com/YunYouJun/yunyoujun.github.io/tree/hexo/source/_posts/posts/黑科技：把第三方 iOS 应用转成动态库.md" target="_blank" title="编辑" rel="noopener"><span class="icon iconify" data-icon="ri:edit-line"></span></a></h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2016-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2016-10-16T00:00:00+08:00">2016-10-16</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2023-10-20 20:32:48" itemprop="dateModified" datetime="2023-10-20T20:32:48+08:00">2023-10-20</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">他山之石</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%8A%A8%E6%80%81%E5%BA%93/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">动态库</span></a><a class="tag-item" href="/tags/%E9%BB%91%E7%A7%91%E6%8A%80/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">黑科技</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p><strong>文章转载自<a target="_blank" rel="noopener" href="http://blog.imjun.net/">杨君的小黑屋</a>，对排版进行了一些调整</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文会介绍一个自己写的工具，能够把第三方iOS应用转成动态库，并加载到自己的App中，文章最后会以支付宝为例，展示如何调用其中的C函数和OC方法。<br>工具开源地址：<br><a target="_blank" rel="noopener" href="https://github.com/tobefuturer/app2dylib">https://github.com/tobefuturer/app2dylib</a>  </p>
<span id="more"></span>
<h2 id="有什么用"><a href="#有什么用" class="headerlink" title="有什么用"></a>有什么用</h2><p>为什么要把第三方应用转成动态库呢？与一般的注入动态库+重签名打包的手段有什么不一样呢？</p>
<p>好处主要有下面几点：<br>1.	可以直接调用别人的算法<br>    逆向分析别人的应用时，可能会遇到一些私有算法，如果搞不定的话，直接拿来用就好。<br>2.	掌控程序的控制权<br>    程序的主体是自己的App，第三方应用的代码只是以动态库的形式加载，主要的控制权还是在我们自己手里，所以可以直接绕过应用的检测代码（文章最后有关于这部分攻防的讨论）。<br>3.	同个进程内加载多个应用<br>    重签名打包毕竟只能是原来的应用，但是如果是动态库的话，可以同时加载多个应用到进程内了，比如你想同时把美图秀秀和饿了么加载进来也是可以的（秀秀不饿，想想去年大众点评那个APPmixer的软广 - -! ）。  </p>
<h2 id="应用和动态库的异同"><a href="#应用和动态库的异同" class="headerlink" title="应用和动态库的异同"></a>应用和动态库的异同</h2><p>我们要把应用转成动态库，首先要知道这两者之前有什么相同与不同，有相同的才存在转换的可能，而不同之处就是我们要重点关注的了。  </p>
<h3 id="相同点："><a href="#相同点：" class="headerlink" title="相同点："></a>相同点：</h3><p><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%BA%94%E7%94%A8%E4%B8%8E%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB.jpg" alt="应用和动态库的异同" loading="lazy"><br>可执行文件和动态库都是标准的 Mach-O 文件格式，两者的文件头部结构非常类似，特别是其中的代码段（TEXT）,和数据段（DATA）结构完全一致，这也是后面转换工作的基础。  </p>
<h3 id="不同点："><a href="#不同点：" class="headerlink" title="不同点："></a>不同点：</h3><p>不同点就是我们转换工作的重点了，主要有：<br>1.	头部的文件类型<br>    一个是 MH_EXECUTE 可执行文件， 一个是 MH_DYLIB 动态库， 还有各种头部的Flags，要特别留意下可执行文件中Flags部分的 MH_PIE 标志，后面再详细说。<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%B4%E9%83%A8%E6%96%87%E4%BB%B6%E4%B8%8D%E5%90%8C.jpg" alt="头部的文件类型不同" loading="lazy"><br>2.	动态库文件中多一个类型为 LC_ID_DYLIB 的 Load Command, 作用是动态库的标识符，一般为文件路径。路径可以随便填，但是这部分必须要有，是codesign的要求。<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%9A%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%9E%8B.jpg" alt="LC_ID_DYLIB 的 Load Command" loading="lazy"><br>3.	可执行文件会多出一个 PAGEZERO段，动态库中没有。这个段开始地址为0（NULL指针指向的位置），是一个不可读、不可写、不可执行的空间，能够在空指针访问时抛出异常。这个段的大小，32位上是0x4000，64位上是4G。这个段的处理也是转换工作的重点之一，之前有人尝试转换，不成功就是因为没有处理好 PAGEZERO.<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%E5%A4%9A%E5%87%BA%E4%B8%80%E4%B8%AA%20PAGEZERO%E6%AE%B5.jpg" alt="多出的PAGEZERO段" loading="lazy">  </p>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="修改文件类型"><a href="#修改文件类型" class="headerlink" title="修改文件类型"></a>修改文件类型</h3><p>第一步是修改文件的头部信息，把文件类型从可执行文件修改成动态库，同时把一些Flags修改好。</p>
<p>这里一个比较关键的Flag是可执行文件中的 MH_PIE 标志位，（position-independent executable）。</p>
<p>这个标志位，表明可执行文件能够在内存中任意位置正确地运行，而不受其绝对地址影响的特性，这一特性是动态库所必须的一个特性。没有这个标志位的可执行文件是没有办法转换成动态库的。iOS系统中，arm64架构下，目前这个标志位是必须的，不然程序无法运行（系统的安全性要求），但是armv7架构下，可以没有这个标志位，所以支付宝armv7版本的可执行文件是不能转成动态库的，就是这个原因。不过所有的arm64的应用都是可以转换的，后面演示时用的支付宝是arm64架构的。<br>###	头部中添加 LC_ID_DYLIB<br>直接在文件头部中按照文档格式插入一个Load Command，并填入合适的数据。这里要注意下插入内容的字节数必须是8字节对齐的。<br>###	修改PAGEZERO段<br>这部分是最重要的一部分，因为arm64上这个段的大小有4G，直接往内存中加载，会提示没有足够的连续的地址空间，所以必须要调整这个段的大小，而要调整 PAGEZERO 这个段的大小, 又会引起一连串的地址空间的变化，所以不能盲目的直接改，必须结合dyld的源码来对应修改。（注意这里不能直接把 PAGEZERO 这个段给去掉，也不能直接把大小调成0，因为涉及到dyld的rebase操作，详细看后面）  </p>
<h4 id="1-所有段的地址都要重新计算"><a href="#1-所有段的地址都要重新计算" class="headerlink" title="1.	所有段的地址都要重新计算"></a>1.	所有段的地址都要重新计算</h4><p>单纯减少 PAGEZERO 段的占用空间，作用不大，因为dyld加载动态库的时候，要求是所有的段一起进行mmap（详细可以查看dyld源码的ImageLoaderMachO::assignSegmentAddresses函数），所以必须把接下来所有的段的地址都重新计算一次。</p>
<p>同时要保证，前后两个段没有地址空间重叠，并且每个段都是按0x4000对齐。因为 PAGEZERO 是所有段中的第一个，所以可以直接把 PAGEZERO 的大小调整到0x4000，然后后面每一个段都按顺序依次减少同样大小(0xFFFFC000 &#x3D; 0x100000000 - 0x4000)，同时能保证每个段在文件内的偏移量不变。</p>
<p><strong>修改前：</strong><br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-PAGEZERO%E6%AE%B5%E4%BF%AE%E6%94%B9%E5%89%8D.jpg" alt="PAGEZERO段修改前" loading="lazy">  </p>
<p><strong>修改后：</strong><br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-PAGEZERO%E6%AE%B5%E4%BF%AE%E6%94%B9%E5%90%8E.jpg" alt="PAGEZERO段修改后" loading="lazy">  </p>
<h4 id="2-对动态库进行rebase操作"><a href="#2-对动态库进行rebase操作" class="headerlink" title="2.	对动态库进行rebase操作"></a>2.	对动态库进行rebase操作</h4><p>这里的rebase是系统为了解决动态库虚拟内存地址冲突，在加载动态库时进行的基地址重定位操作。</p>
<p>这一步操作是整个流程里最重要的，因为按照前面的操作，整个文件地址空间已经发生了变化，如果dyld依然按照原来的地址进行rebase，必然会失败。</p>
<p>那么rebase操作需要做哪些工作呢？</p>
<p>相关的信息储存在 Mach-O 文件的 LINKEDIT 段中, 并由 LC_DYLD_INFO_ONLY 指定 rebase info 在文件中的偏移量<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E5%81%8F%E7%A7%BB%E9%87%8F.jpg" alt="rebase在文件中的偏移量" loading="lazy">  </p>
<p>详细的rebase信息:<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.jpg" alt="详细的rebase信息" loading="lazy">  </p>
<p>红框里那些Pointer的意思是说，在内存地址为 0x367C698 的地方有一个指针，这个指针需要进行rebase操作, 操作的内容就是和前面调整地址空间一样，每个指针减去 0xFFFFC000。<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20%E4%B8%AD%E6%8C%87%E9%92%88%E5%87%8F0xFFFFC000.jpg" loading="lazy">  </p>
<h4 id="3-为什么不能直接去掉PAGEZERO这个段"><a href="#3-为什么不能直接去掉PAGEZERO这个段" class="headerlink" title="3.	为什么不能直接去掉PAGEZERO这个段"></a>3.	为什么不能直接去掉PAGEZERO这个段</h4><p>这个原因要涉及到文件中rebase信息的储存格式，上面的图中，可以看出rebase要处理的是一个个指针，但是实际上这些信息在文件中并不是以指针数组的形式存在，而是以一连串rebase opcode的形式存在，上面看到的一个个指针其实是 Mach O View 这个软件帮我们将opcode整理得到的。<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20rebase%20opcode.jpg" loading="lazy">  </p>
<p>这些opcode中有一种操作比较关键，REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB。<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB.jpg" loading="lazy">  </p>
<p>这个opcode的意思是, 接下去需要调整文件的中的第2个段，就是图中segment(2)所表示的含义。</p>
<p>所以说，如果把PAGEZERO这个段给去掉了，文件中各个段的序号也就都错位了，与rebase中的信息就对应不上了。<br>而且把这个段大小改为0，也是不行的，因为dyld在加载的过程中，会重新自动过滤掉大小为0的段，也会导致同样的段序号错位的问题。（有兴趣的同学可以看下dyld的源码，在ImageLoaderMachO类的构造函数里）<br>这就是为什么必须要保留PAGEZERO这个段，同时大小不能为0。  </p>
<h3 id="修改符号表"><a href="#修改符号表" class="headerlink" title="修改符号表"></a>修改符号表</h3><p>正常的线上应用是不存在符号表的，但是如果你之前用了我的另一个工具 <a target="_blank" rel="noopener" href="https://github.com/tobefuturer/restore-symbol">restore-symbol</a>来恢复符号表的话，这个地方自然也需要做一些处理，处理方法同rebase类似，减去0xFFFFC000.</p>
<p>不过有一些符号需要单独过滤，比如这个：<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E4%BF%AE%E6%94%B9%E7%AC%A6%E5%8F%B7%E8%A1%A8.jpg" loading="lazy">  </p>
<p>这个radr:&#x2F;&#x2F;5614542是个什么神奇的符号呢，google就能发现，念茜的twitter上提过这个奇葩的符号。(女神果然是女神, 棒~ 😂)<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E5%BF%B5%E8%8C%9Ctwitter.jpg" loading="lazy">  </p>
<h2 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h2><p>工具开源在<a target="_blank" rel="noopener" href="https://github.com/tobefuturer/app2dylib">github</a>上，用法：<br>###	1.	下载源码编译：</p>
<pre class="language-git" data-language="git"><code class="language-git">git clone --recursive https://github.com/tobefuturer/app2dylib.git
cd app2dylib &amp;&amp; make
./app2dylib</code></pre>
<h3 id="2-把支付宝arm64砸壳，然后提取可执行文件，用上面的工具把支付宝的可执行文件转成动态库"><a href="#2-把支付宝arm64砸壳，然后提取可执行文件，用上面的工具把支付宝的可执行文件转成动态库" class="headerlink" title="2.	把支付宝arm64砸壳，然后提取可执行文件，用上面的工具把支付宝的可执行文件转成动态库"></a>2.	把支付宝arm64砸壳，然后提取可执行文件，用上面的工具把支付宝的可执行文件转成动态库</h3><pre class="language-linux" data-language="linux"><code class="language-linux">.&#x2F;app2dylib &#x2F;tmp&#x2F;AlipayWallet -o &#x2F;tmp&#x2F;libAlipayApp.dylib   </code></pre>
<h3 id="3-用-Xcode-新建工程，并把新生成的dylib拖进去，调整好各项设置"><a href="#3-用-Xcode-新建工程，并把新生成的dylib拖进去，调整好各项设置" class="headerlink" title="3.	用 Xcode 新建工程，并把新生成的dylib拖进去，调整好各项设置."></a>3.	用 Xcode 新建工程，并把新生成的dylib拖进去，调整好各项设置.</h3><p><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20Xcode%E6%96%B0%E5%BB%BA%E5%B7%A5%E7%A8%8B.jpg" loading="lazy">  </p>
<p>Run Script里的代码(目的是为了对dylib进行签名)  </p>
<pre><code class="linux">cd $&#123;BUILT_PRODUCTS_DIR&#125;
cd $&#123;FULL_PRODUCT_NAME&#125;
/usr/bin/codesign --force --sign $&#123;EXPANDED_CODE_SIGN_IDENTITY&#125; --timestamp=none libAlipayApp.dylib
</code></pre>
<h3 id="4-怎么调用动态库里的方法呢？"><a href="#4-怎么调用动态库里的方法呢？" class="headerlink" title="4.	怎么调用动态库里的方法呢？"></a>4.	怎么调用动态库里的方法呢？</h3><p>为方便大家尝试，这里选两个分析起来比较简单的函数调用演示给大家。</p>
<p>一个是OC的方法 <code>+[aluSecurity rsaEncryptText:pubKey:]</code>, 可以直接用oc运行时调用。</p>
<p>另一个是C的函数 <code>int base64_encode(char * output, int * output_length, char * input, int input_length)</code><br>这个需要先确定 base64_encode 这个C函数的函数签名和在dylib中的偏移地址（我这边的9.9.3版本是0xa798e4），可以用ida分析得到。</p>
<p>运行结果：<br><img src="http://img.gaoshilei.com/App%E8%BD%AC%E6%88%90%E5%8A%A8%E6%80%81%E5%BA%93-%20%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C.jpg" loading="lazy">  </p>
<pre><code class="C">#import &lt;UIKit/UIKit.h&gt;
#import &lt;dlfcn.h&gt;
#import &lt;mach/mach.h&gt;
#import &lt;mach-o/loader.h&gt;
#import &lt;mach-o/dyld.h&gt;
#import &lt;objc/runtime.h&gt;
int main(int argc, char * argv[]) &#123;
    NSLog(@&quot;\n===Start===\n&quot;);
    NSString * dylibName = @&quot;libAlipayApp&quot;;
    NSString * path = [[NSBundle mainBundle] pathForResource:dylibName ofType:@&quot;dylib&quot;];
    if (dlopen(path.UTF8String, RTLD_NOW) == NULL)&#123;
        NSLog(@&quot;dlopen failed ，error %s&quot;, dlerror());
        return 0;
    &#125;;
    
    //运行时 直接调用oc方法
    NSString * plain = @&quot;alipay&quot;;
    NSString * pubkey = @&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZ6i9VNEGEaZaYE7XffA9XRj15cp/ZKhHYY43EEva8LIhCWi29EREaF4JjZVMwFpUAfrL+9gpA7NMQmaMRHbrz1KHe2Ho4HpUhEac8M9zUbNvaDKSlhx0lq/15TQP+57oQbfJ9oKKd+he4Yd6jpBI3UtGmwJyN/T1S0DQ0aXR8OQIDAQAB&quot;;
    NSString * cipher = [NSClassFromString(@&quot;aluSecurity&quot;) performSelector:NSSelectorFromString(@&quot;rsaEncryptText:pubKey:&quot;) withObject:plain withObject:pubkey];
    NSLog(@&quot;\n-----------call oc method---------\n明文：%@\n密文： %@\n-----------------------------------&quot;, plain,cipher);
    
    //确认dylib加载在内存中的地址
    uint64_t slide = 0;
    for (int i = 0; i &lt;  _dyld_image_count(); i ++)
        if ([[NSString stringWithUTF8String:_dyld_get_image_name(i)] isEqualToString:path])
            slide = _dyld_get_image_vmaddr_slide(i);
    assert(slide != 0);
    
    
    typedef int (*BASE64_ENCODE_FUNC_TYPE) (char * output, int * output_size , char * input, int input_length);
    /** 根据偏移算出函数地址， 然后调用*/
    long long base64_encode_offset_in_dylib = 0xa798e4;
    BASE64_ENCODE_FUNC_TYPE base64_encode = (BASE64_ENCODE_FUNC_TYPE)(slide + base64_encode_offset_in_dylib);
    char output[1000] = &#123;0&#125;;
    int length = 1000;
    char * input = &quot;alipay&quot;;
    base64_encode(output, &amp; length,  input, (int)strlen(input));
    NSLog(@&quot;\n-----------call c function---------\nbase64: %s -&gt; %s\n-----------------------------------&quot;, input,  output);
&#125;
</code></pre>
<p>ps：示例代码中，我刻意除掉了界面部分的代码，因为支付宝的+load函数里swizzle了UI层的一些方法，会导致crash，如果想干掉那些+load方法的话，看下面。  </p>
<h2 id="关于绕过检测代码"><a href="#关于绕过检测代码" class="headerlink" title="关于绕过检测代码"></a>关于绕过检测代码</h2><p>文章开头的简介中有提到，以动态库的形式加载，能够绕过应用的检测代码，这说法不完全，因为如果把检测代码写在类的+load方法里或者mod_init_func函数（ 全局静态变量的构造函数和__attribute__((constructor))指定的函数 ）里，在dylib加载的时候也是可以得到调用的。</p>
<p>那么也就衍生出两种配搭的对抗方案：<br><strong>i）越狱机</strong><br>+load方法的调用是在libobjc.dylib中的call_load_methods函数， mod_init_func函数的调用是在dyld中的doModInitFunctions函数，可以直接用CydiaSubstrate inline hook掉这两个函数，而且动态库是由我们自己加载的，所以可以控制hook和加载dylib的时序。</p>
<p><strong>ii) 非越狱机</strong><br>非越狱机上，没有办法inline hook，但是可以利用_dyld_register_func_for_add_image 这个函数注册回调，这个回调是发生在动态库加载到内存后，+load方法和mod_init_func函数调用前，所以可以在这个回调里把+load方法改名，把mod_init_func段改名等等，也就可以使得各种检测函数没法调用了。</p>
<p>总之，主要的控制权还是在我们手中。<br>测试环境：<br>iPhone 6Plus 、iOS 9.3.1 、arm64<br>支付宝9.9.3</p>
<p>参考链接&amp;致谢<br>1.	dyld的源码：<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/dyld/">https://opensource.apple.com/source/dyld/</a><br>2.	iOS逆向的论坛 <a target="_blank" rel="noopener" href="http://iosre.com/">http://iosre.com/</a></p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>LeonLei</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://www.gaoshilei.com/iOSAppToLibrary/" title="【转载】黑科技：把第三方iOS应用转成动态库">http://www.gaoshilei.com/iOSAppToLibrary/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E9%80%86%E5%90%91%E5%BE%AE%E4%BF%A1%E4%B9%8B%E6%9C%8B%E5%8F%8B%E5%9C%88%E5%B0%8F%E8%A7%86%E9%A2%91%E8%BD%AC%E5%8F%91%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="prev" title="手把手教你逆向微信之朋友圈小视频转发（上）"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">手把手教你逆向微信之朋友圈小视频转发（上）</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/iphone-serial-number/" rel="next" title="iPhone查找序列号生成函数"><span class="post-nav-text">iPhone查找序列号生成函数</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何内容想要讨论，欢迎前往 <a href="https://github.com/gaoshilei" target="_blank">GitHub</a> 与我交流。</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备19073416号</a></div><div class="copyright"><span>&copy; 2016 – 2023 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> LeonLei</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v6.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.7</span></div><div class="footer-support"><span>本网站由</span><a class="footer-support-logo" href="https://s.qiniu.com/IVvymu" target="blank" title="七牛云"><img height="30" src="https://img.gaoshilei.com/qiniuyun-logo.png" alt="七牛云"></a><span>提供储存和 CDN 加速</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><!-- hexo injector body_end start --><script src="/js/hexo-tag-common.js"></script><!-- hexo injector body_end end --></body></html>